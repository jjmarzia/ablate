environment:
  title: nphase-surfaceforce
  tagDirectory: true
arguments:
  dm_plex_gmsh_use_regions: true
  dm_plex_check_all: true
timestepper:
  name: theMainTimeStepper
  arguments:
    ts_type: euler
    ts_max_time: 1e-4 #0.1
    ts_dt: 1e-4
    ts_adapt_type: none
  io: !<!ablate::io::Hdf5MultiFileSerializer>
    interval: !<!ablate::io::interval::FixedInterval> 100
  domain: !<!ablate::domain::BoxMesh> &1
    name: testMesh
    faces: [200, 50]  # [x, y] resolution - higher in x for better circle representation
    lower: [0.0, 0.0]
    upper: [2.0, 0.5]  # Domain is 2x0.5
    boundary: [NONE, NONE]
    modifiers:
      - !<!ablate::domain::modifiers::DistributeWithGhostCells>
        ghostCellDepth: 2
      - !<!ablate::domain::modifiers::GhostBoundaryCells>
        labelName: ""
    fields:
      - !<!ablate::finiteVolume::NPhaseFlowFields>
        eos: !<!ablate::eos::NPhase> &eos
          eosk:
            - !<!ablate::eos::KthStiffenedGas> &aireos1  
              parameters:
                gamma: 1.4 
                Cp: 1004.5 
                p0: 0.0 
            - !<!ablate::eos::KthStiffenedGas> &aireos2
              parameters:
                gamma: 1.4 
                Cp: 1004.5 
                p0: 0.0 
            - !<!ablate::eos::KthStiffenedGas> &aireos3
              parameters:
                gamma: 1.4 
                Cp: 1004.5 
                p0: 0.0 
      - name: p
        location: AUX
        type: FVM
      - name: rhok
        location: AUX
        type: FVM
        components: [rhok0, rhok1, rhok2]
      - name: tk
        location: AUX
        type: FVM
        components: [tk0, tk1, tk2]
      - name: epsilonk
        location: AUX
        type: FVM
        components: [epsilonk0, epsilonk1, epsilonk2]
      - name: rho
        location: AUX
        type: FVM
      - name: sosk
        location: AUX
        type: FVM
        components: [sosk0, sosk1, sosk2]
      - name: kappa_0_1
        location: AUX
        type: FVM
      - name: kappa_0_2
        location: AUX
        type: FVM
      - name: kappa_1_2
        location: AUX
        type: FVM
      - name: debug
        location: AUX
        type: FVM
        components: [debug0, debug1, debug2]
  initialization:
    - fieldName: allaire
      field: !<!ablate::mathFunctions::Formula> &allaireInit
        formula: "rho1*(eps1 + (u*u + v*v)/2)*(circle1) + rho2*(eps2+(u*u + v*v)/2)*(circle2) + rho3*(eps3+(u*u + v*v)/2)*(1-circle1-circle2), rho1*u*(circle1) + rho2*u*(circle2) + rho3*u*(1-circle1-circle2), rho1*v*(circle1) + rho2*v*(circle2) + rho3*v*(1-circle1-circle2)"
        constants: &constants
          rho1: 1.0    # Density of first circle
          rho2: 1.0    # Density of second circle
          rho3: 1.0    # Density of background
          eps1: 2.5    # Internal energy of first circle
          eps2: 2.5    # Internal energy of second circle
          eps3: 1.5    # Internal energy of background
          u: 1.0       # x-velocity
          v: 0.0       # y-velocity (zero for pure x-advection)
        nested:
          circle1: !<!ablate::mathFunctions::Formula> &circle1
            formula: "0.5*(1.0 - tanh((sqrt((x-0.3)^2 + (y-0.25)^2) - 0.05)/(0.01)))"
          circle2: !<!ablate::mathFunctions::Formula> &circle2
            formula: "0.5*(1.0 - tanh((sqrt((x-0.7)^2 + (y-0.25)^2) - 0.05)/(0.01)))"
    - fieldName: alphakrhok
      field: !<!ablate::mathFunctions::Formula> &alphakrhokInit
        formula: "rho1*circle1, rho2*circle2, rho3*(1-circle1-circle2)"
        constants: *constants
        nested:
          circle1: *circle1
          circle2: *circle2
    - fieldName: alphak
      field: !<!ablate::mathFunctions::Formula> &alphakInit
        formula: "circle1, circle2, (1-circle1-circle2)"
        nested:
          circle1: *circle1
          circle2: *circle2
solver: !<!ablate::finiteVolume::FiniteVolumeSolver>
  id: nPhase Problem
  processes:
    - !<!ablate::finiteVolume::processes::NPhaseAllaireAdvection>
      eos: *eos
      fluxCalculatorNStiff: !<!ablate::finiteVolume::fluxCalculator::AusmpUp>
        mInf: 0.3
    - !<!ablate::finiteVolume::processes::NPhaseNonconservativeRHS>
      mInf: 0.3
#    - !<!ablate::finiteVolume::processes::NPhaseSurfaceForce>
#      sigma: [[0.0, 1.0, 1.0], [1.0, 0.0, 1.0], [1.0, 1.0, 0.0]]  # Surface tension between phases
#      C: 0.1  # Smoothing parameter
#      N: 3.0  # Number of standard deviations
  boundaryConditions:
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: allaire walls
      labelIds: [1, 2, 3, 4]  # All four boundaries
      boundaryValue:
        fieldName: allaire
        field: *allaireInit
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: alphakrhok walls
      labelIds: [1, 2, 3, 4]
      boundaryValue:
        fieldName: alphakrhok
        field: *alphakrhokInit
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: alphak walls
      labelIds: [1, 2, 3, 4]
      boundaryValue:
        fieldName: alphak
        field: *alphakInit
  monitors:
    - !<!ablate::monitors::TimeStepMonitor>
      interval: 1