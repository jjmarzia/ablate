environment:
  title: nphase-gradient-test
  tagDirectory: true

arguments:
  dm_plex_gmsh_use_regions: true
  dm_plex_check_all: true

timestepper:
  name: theMainTimeStepper
  arguments:
    ts_type: euler
    ts_max_time: 1e-7  # Shorter time for testing
    ts_dt: 1e-7
    ts_adapt_type: none

  domain: !<!ablate::domain::BoxMesh> &1
    name: testMesh
    faces: [100]  # 100 cells for good resolution
    lower: [0.0]
    upper: [1.0]
    boundary: [NONE]
    modifiers:
      - !<!ablate::domain::modifiers::DistributeWithGhostCells>
        ghostCellDepth: 2
      - !<!ablate::domain::modifiers::GhostBoundaryCells>
        labelName: ""
    fields:
      - !<!ablate::finiteVolume::NPhaseFlowFields>
        eos: !<!ablate::eos::NPhase> &eos
          eosk:
            - !<!ablate::eos::KthStiffenedGas>
              parameters:
                gamma: 4.4
                Cp: 4186.0
                p0: 6e8
            - !<!ablate::eos::KthStiffenedGas>
              parameters:
                gamma: 1.4
                Cp: 1004.5
                p0: 0.0
        conservedFieldOptions:
          petscfv_type: leastsquares
          petscfv_compute_gradients: true
      - name: p
        location: AUX
        type: FVM
      - name: rhok
        location: AUX
        type: FVM
        components: [rhok0, rhok1]
      - name: tk
        location: AUX
        type: FVM
        components: [tk0, tk1]
      - name: epsilonk
        location: AUX
        type: FVM
        components: [epsilonk0, epsilonk1]
      - name: rho
        location: AUX
        type: FVM
      - name: sosk
        location: AUX
        type: FVM
        components: [sosk0, sosk1]
      - name: debug
        location: AUX
        type: FVM
        components: [debug0, debug1]

  initialization:
    - fieldName: allaire
      field: !<!ablate::mathFunctions::Formula> &allaireInit
        # Linear function with slope 1: x + base_value
        formula: "x + base_value, 0"
        constants: &constants
          base_value: 1000  # Base value for energy
    - fieldName: alphakrhok
      field: !<!ablate::mathFunctions::Formula> &alphakrhokInit
        # Linear functions with slope 1 for each phase
        formula: "x + rho1_base, x + rho2_base"
        constants: *constants
        nested:
          rho1_base: 1000  # Base density for phase 1
          rho2_base: 10    # Base density for phase 2
    - fieldName: alphak
      field: !<!ablate::mathFunctions::Formula> &alphakInit
        # Linear functions with slope 1 for volume fractions
        # Note: These are scaled to ensure they sum to 1
        formula: "0.5 + 0.4*x, 0.5 - 0.4*x"  # Sum is always 1, gradients are 0.4 and -0.4

solver: !<!ablate::finiteVolume::FiniteVolumeSolver>
  id: nPhase Gradient Test
  processes:
    - !<!ablate::finiteVolume::processes::NPhaseAllaireAdvection>
      eos: *eos
      fluxCalculatorNStiff: !<!ablate::finiteVolume::fluxCalculator::AusmpUp>
        mInf: 0.3
    - !<!ablate::finiteVolume::processes::NPhaseNonconservativeRHS>
      mInf: 0.3

  boundaryConditions:
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: allaire walls
      labelIds: [1, 2]  
      boundaryValue:
        fieldName: allaire
        field: *allaireInit
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: alphakrhok walls
      labelIds: [1, 2]
      boundaryValue:
        fieldName: alphakrhok
        field: *alphakrhokInit
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: alphak walls
      labelIds: [1, 2]
      boundaryValue:
        fieldName: alphak
        field: *alphakInit

  monitors:
    - !<!ablate::monitors::TimeStepMonitor>
      interval: 1
    - !<!ablate::monitors::CurveMonitor>
      interval: 1 