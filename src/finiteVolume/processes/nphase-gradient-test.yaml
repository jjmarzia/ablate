environment:
  title: nphase-gradient-test
  tagDirectory: true

arguments:
  dm_plex_gmsh_use_regions: true
  dm_plex_check_all: true

timestepper:
  name: theMainTimeStepper
  arguments:
    ts_type: euler
    ts_max_time: 1e-7
    ts_dt: 1e-7
    ts_adapt_type: none

domain: !<!ablate::domain::BoxMesh> &1
  name: testMesh
  faces: [101]
  lower: [0.0]
  upper: [1.0]
  boundary: [NONE]
  modifiers:
    - !<!ablate::domain::modifiers::DistributeWithGhostCells>
      ghostCellDepth: 2
    - !<!ablate::domain::modifiers::GhostBoundaryCells>
      labelName: ""
  fields:
    - !<!ablate::finiteVolume::NPhaseFlowFields>
      eos: !<!ablate::eos::NPhase> &eos
        eosk:
          - !<!ablate::eos::KthStiffenedGas>
            parameters:
              gamma: 1.4
              Cp: 1004.5
              p0: 0.0
      conservedFieldOptions:
        petscfv_type: leastsquares
        petscfv_compute_gradients: true
    - name: p
      location: AUX
      type: FVM
    - name: rhok
      location: AUX
      type: FVM
      components: [rhok0]
    - name: tk
      location: AUX
      type: FVM
      components: [tk0]
    - name: epsilonk
      location: AUX
      type: FVM
      components: [epsilonk0]
    - name: rho
      location: AUX
      type: FVM
    - name: sosk
      location: AUX
      type: FVM
      components: [sosk0]
    - name: debug
      location: AUX
      type: FVM
      components: [debug0]

initialization:
  - fieldName: allaire
    field: !<!ablate::mathFunctions::Formula> &allaireInit
      formula: "1000, 0"  # Constant energy
  - fieldName: alphakrhok
    field: !<!ablate::mathFunctions::Formula> &alphakrhokInit
      # Creates a step function using min/max: 1 for x < 0.49, 100 for 0.49 <= x <= 0.51, 101 for x > 0.51
      formula: "1*cond0 + 100*cond1 + 101*cond2"
      nested:
        cond1: !<!ablate::mathFunctions::Formula>
          formula: "x > 0.49 && x < 0.51 ? 1 : 0"
        cond2: !<!ablate::mathFunctions::Formula>
          formula: "x > 0.51 ? 1 : 0"
        cond0: !<!ablate::mathFunctions::Formula>
          formula: "x < 0.49 ? 1 : 0"
  - fieldName: alphak
    field: !<!ablate::mathFunctions::Formula> &alphakInit
      formula: "1"  # Constant volume fraction of 1

solver: !<!ablate::finiteVolume::FiniteVolumeSolver>
  id: nPhase Gradient Test
  processes:
    - !<!ablate::finiteVolume::processes::NPhaseAllaireAdvection>
      eos: *eos
      fluxCalculatorNStiff: !<!ablate::finiteVolume::fluxCalculator::AusmpUp>
        mInf: 0.3
    - !<!ablate::finiteVolume::processes::NPhaseNonconservativeRHS>
      mInf: 0.3

  boundaryConditions:
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: allaire walls
      labelIds: [1, 2]  
      boundaryValue:
        fieldName: allaire
        field: *allaireInit
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: alphakrhok walls
      labelIds: [1, 2]
      boundaryValue:
        fieldName: alphakrhok
        field: *alphakrhokInit
    - !<!ablate::finiteVolume::boundaryConditions::EssentialGhost>
      boundaryName: alphak walls
      labelIds: [1, 2]
      boundaryValue:
        fieldName: alphak
        field: *alphakInit

  monitors:
    - !<!ablate::monitors::TimeStepMonitor>
      interval: 1
    - !<!ablate::monitors::CurveMonitor>
      interval: 1 